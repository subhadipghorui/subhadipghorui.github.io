<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>GIS Collage Map</title>

    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.6.0/dist/leaflet.css"
        integrity="sha512-xwE/Az9zrjBIphAcBb3F6JVqxf46+CDLwfLMHloNu6KEQCAWi6HcDUbeOfBIptF7tcCzusKFjFw2yuvEpDL9wQ=="
        crossorigin="" />
    <script src="https://unpkg.com/leaflet@1.6.0/dist/leaflet.js"
        integrity="sha512-gZwIG9x3wUXg2hdXF6+rVkLF/0Vi9U8D2Ntg4Ga5I5BZpVkVxlJWbSQtXPSiUTtC0TjtGOmxa1AJPuV0CPthew=="
        crossorigin=""></script>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/d3/5.16.0/d3.min.js"></script>

    <!-- Font awasom -->
    <script src="https://kit.fontawesome.com/6e54032103.js" crossorigin="anonymous"></script>
    <!-- Turf -->
    <script src="https://cdn.jsdelivr.net/npm/@turf/turf@5/turf.min.js"></script>
    <script src='csvjson.js'></script>

    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        .map-container {
            width: 100vw;
            height: 80vh;
        }
        h1{
            padding: 1rem;
            margin: 0.6rem auto;
            text-align: center;
        }
    </style>
</head>

<body>
    <h1>Click anywhere in the map to Calculate the nearest Collage Location on the Map. </h1>
    <div id="map" class="map-container"></div>
    <script>
        // **************************************************************************
        // Create a container
        var map = L.map('map',
            {
                closePopupOnClick: false,
                // zoomControl: false,

            });


        map.setView([23.57, 87.36], 7);

        // Create Attribution
        mapLink = '<a href="http://openstreetmap.org">OpenStreetMap</a>';

        // Add tile 
        L.tileLayer(
            'http://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',
            { attribution: 'Map data &copy; ' + mapLink, minZoom: 2.2, }).addTo(map);

        // *****************************************************************************
        //  Make the Markers Variable and remove theme first

        const me = L.marker([0, 0])
            .addTo(map)
            .bindPopup('My Location')
            .remove();
        const reslut = L.marker([0, 0])
            .addTo(map)
            .remove();
        const resultLine = L.polyline([[0, 0], [0, 0]], {
            color: 'green',
        }).addTo(map)
            .remove();



        // ********************************************************
        //  Where Ever Clicked it will show the latlon 
        //  and the

        function onMapClick(e) {
            // alert("You clicked the map at " + e.latlng);
            console.log(e.latlng);
            getNearByLocation(e.latlng.lat, e.latlng.lng);
        }

        map.on('click', onMapClick);

        // ********************************************************

        var points_collection = [];
        var point = {};
        function getCollages() {
            i = 0;
            bu_clg.forEach(row => {
                console.log(row);
                // *********************************************
                // Calculate near point with turf

                point = turf.point([eval(row.Y), eval(row.X)]);

                points_collection[i] = point;


                var myIcon = L.icon({
                    iconUrl: 'university-solid.svg',
                    iconSize: [38, 95],
                    iconAnchor: [22, 94],
                    popupAnchor: [-3, -76],
                    shadowSize: [68, 95],
                    shadowAnchor: [22, 94]
                });
                //   var  myIcon = L.divIcon({html: '<i class="fas fa-university"></i>'});

                L.marker([eval(row.Y), eval(row.X)], { icon: myIcon })
                    .addTo(map)
                    .bindPopup(row["BURDWAN UNIVERSITY (NAME OF COLLEGES)"])
                    // .openOn(map)
                    .openPopup();


                // ****************************************
                i++;
            });
        }
        getCollages();
        // ********************************************************
        // *************************** Get the Nearest Point ******************************

        //  Load the data
        function getNearByLocation(lat, lon) {
            const targetPoint = turf.point([lat, lon], { "marker-color": "#333" });
            var points = turf.featureCollection(points_collection);
            var nearest = turf.nearestPoint(targetPoint, points);
            console.log(nearest);

            // ***************** Remodify the markers ***********************

            map.setView([lat, lon], 9); // set the view
            me.setLatLng([lat, lon])
                .openPopup()
                .addTo(map);            // addTo(map)---- add the remove icon

            reslut.setLatLng([nearest.geometry.coordinates[0], nearest.geometry.coordinates[1]])
                .bindPopup(bu_clg[nearest.properties.featureIndex]["BURDWAN UNIVERSITY (NAME OF COLLEGES)"])
                // .openOn(map)
                .openPopup()
                .addTo(map);             // addTo(map)---- add the remove icon

            resultLine.setLatLngs([[lat, lon], [nearest.geometry.coordinates[0], nearest.geometry.coordinates[1]]])
                .addTo(map)
                .bindPopup(`${bu_clg[nearest.properties.featureIndex]["BURDWAN UNIVERSITY (NAME OF COLLEGES)"]} <br>The Distance is ${nearest.properties.distanceToPoint*1.6*1000} meter`)
                .openPopup();                 // addTo(map)---- add the remove icon
        }
        //getData();




// *********************************************************

    </script>
</body>

</html>